import requests
import json

def generate_report(patient_name, examination_date, preliminary_diagnosis):
    # Словарь диагнозов для подстановки
    diagnosis_dict = {
        "glioma_tumor": "Глиома",
        "meningioma_tumor": "Менингиома",
        "pituitary_tumor": "Опухоль гипофиза",
        "normal": "Норма"  # Новый диагноз
    }
    russian_diagnosis = diagnosis_dict.get(preliminary_diagnosis, "Неизвестный диагноз")

    # Шаблон отчета
    if preliminary_diagnosis == "normal":
        # Если диагноз "норма", меняем рекомендации и дополнительные исследования
        input_text = f"""
        Отвечай строго на русском.
        Вы медицинский ассистент, специализирующийся на создании профессиональных HTML-отчетов для пациентов.
        Не добавляйте никаких дополнительных комментариев, объяснений или текста за пределами того, что указано в этом шаблоне.
        Строго соблюдайте предоставленную структуру HTML и используйте указанные теги (например, <p>, <ul>, <li>). 
        Не используйте синтаксис Markdown, такой как '**', и не отклоняйтесь от указанного формата.
        Первым предложением ОБЯЗАТЕЛЬНО напишите, что заболевание отсутсвует.
        Каждый раздел (например, "Дополнительные исследования", "Отказ от ответственности") должен быть включен только один раз.
        Вы обязательно ДОЛЖНЫ переформулировать текст внутри тегов, добавляя больше деталей, пояснений и уточнений. 
        Расширьте текст внутри шаблона, чтобы он был информативнее и содержал больше объяснений, но не добавляйте новых данных, которые не указаны в шаблоне.

        <p>У пациента нет выявленных патологий. Обследование показало нормальные результаты.</p>

        <h3>Рекомендации:<h3>
        <ul>
            <li>Продолжайте придерживаться здорового образа жизни и следите за своим самочувствием.</li>
            <li>При необходимости посещайте врача для регулярных профилактических осмотров.</li>
        </ul>

        <h3>Дополнительные исследования:<h3>
        <p>Дополнительные исследования не требуются.</p>

        <h3>Отказ от ответственности:<h3>
        <p>Этот отчет носит исключительно предварительный характер и основан на текущих данных обследования пациента. В случае возникновения симптомов или изменений состояния обратитесь к врачу.</p>
        """
    else:
        # Если есть патология, стандартный отчет
        input_text = f"""
        Отвечай строго на русском.
        Вы медицинский ассистент, специализирующийся на создании профессиональных HTML-отчетов для пациентов.
        Не добавляйте никаких дополнительных комментариев, объяснений или текста за пределами того, что указано в этом шаблоне.
        Строго соблюдайте предоставленную структуру HTML и используйте указанные теги (например, <p>, <ul>, <li>). 
        Не используйте синтаксис Markdown, такой как '**', и не отклоняйтесь от указанного формата.
        Каждый раздел (например, "Дополнительные исследования", "Отказ от ответственности") должен быть включен только один раз.
        Вы обязательно ДОЛЖНЫ переформулировать текст внутри тегов, добавляя больше деталей, пояснений и уточнений. 
        Расширьте текст внутри шаблона, чтобы он был информативнее и содержал больше объяснений, но не добавляйте новых данных, которые не указаны в шаблоне.
        Первым предложением обязательно должна идти информации о заболевании.

        У пациента диагностирована <strong>{russian_diagnosis}</strong>. Это заболевание характеризуется следующими особенностями...

        <h3>Рекомендации:</h3>
        <ul>
            <li><strong>Нейрохирург:</strong> Провести анализ состояния пациента для определения необходимости хирургического вмешательства.</li>
            <li><strong>Онколог:</strong> Разработать план лечения с учетом стадии и типа опухоли.</li>
            <li><strong>Радиолог:</strong> Изучить возможность применения лучевой терапии.</li>
            <li><strong>Психолог:</strong> Оказать поддержку пациенту для адаптации к диагнозу.</li>
        </ul>

        <h3>Дополнительные исследования:</h3>
        <ul>
            <li>МРТ с контрастом для уточнения размеров и границ опухоли.</li>
            <li>КТ для изучения влияния опухоли на соседние структуры.</li>
            <li>Биопсия для подтверждения диагноза и анализа клеточного состава опухоли.</li>
        </ul>

        <h3>Варианты лечения:</h3>
        <ul>
            <li><strong>Хирургическое удаление:</strong> Основной метод лечения для удаления опухоли.</li>
            <li><strong>Лучевая терапия:</strong> Применяется для уничтожения остаточных клеток опухоли.</li>
            <li><strong>Химиотерапия:</strong> Используется для лечения злокачественных опухолей.</li>
        </ul>

        <h3>Отказ от ответственности:</h3>
        <p>Этот отчет носит исключительно предварительный характер и не заменяет профессионального медицинского заключения. Окончательные рекомендации должны быть согласованы с лечащим врачом.</p>
        """

    # Настройка данных для запроса
    payload = {
        "model": "llama3.1:8b-instruct-q8_0",
        "prompt": input_text,
        "max_tokens": 10000
    }

    # Отправка запроса
    response = requests.post("http://localhost:11434/api/generate", json=payload, stream=True)
    if response.status_code == 200:
        full_text = ""
        for line in response.iter_lines():
            if line:
                line_json = json.loads(line.decode('utf-8'))
                full_text += line_json.get("response", "")

        return full_text
    else:
        print(f"Ошибка: {response.status_code}")
        print(response.text)
        return None

if __name__ == "__main__":
    patient_name = "Иванов Иван Иванович"
    examination_date = "23.11.2024"
    preliminary_diagnosis = "normal"  # Измените на один из доступных диагнозов: "glioma_tumor", "meningioma_tumor", "pituitary_tumor", "normal"
    report = generate_report(patient_name, examination_date, preliminary_diagnosis)
    if report:
        print(report)
